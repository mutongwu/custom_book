function initGlobalData(){function i(i){var t=i.split(""),e={},n=0,a=4;return $.each(t,function(i,t){return e[t]?(e[t]+=1,e[t]>2&&(n+=1)):e[t]=1,n>a?!1:void 0}),a>=n}for(var t=["aoxia","baozi","changjinglu","daishu","tiane","fengniao","gezi","haitun","yilong","ji","kongque","luotuo","mifeng","nainiu","haiou","pangxie","qie","rongshu","shizi","tuzi","wugui","lv","woniu","xiongmao","yingwu","zhizhu"],e=["螯虾","豹子","长颈鹿","袋鼠","天鹅","蜂鸟","鸽子","海豚","翼龙","鸡","孔雀","骆驼","蜜蜂","奶牛","海鸥","螃蟹","企鹅","榕树","狮子","兔子","乌龟","驴","蜗牛","熊猫","鹦鹉","蜘蛛"],n=["anchun","banma","ciwei","daxiang","eyu","fenghuang","gou","houzi","yipinhong","jingyu","kaola","lu","maotouying","ningmeng","ou","panyang","qingwa","rougui","songshu","tuoniao","wuya","lvluo","wandou","xiyi","yingtao","zhangyu"],a=["鹌鹑","斑马","刺猬","大象","鳄鱼","凤凰","狗","猴子","一品红","鲸鱼","考拉","鹿","猫头鹰","柠檬","莲藕","盘羊","青蛙","肉桂","松鼠","鸵鸟","乌鸦","绿箩","豌豆","蜥蜴","樱桃","章鱼"],s={},o="abcdefghijklmnopqrstuvwxyz",c=0;26>c;c++)s[o.charAt(c)]=[{zh:e[c],py:t[c]},{zh:a[c],py:n[c]}];var r=[{zh:"白云",py:"baiyun",idx:1},{zh:"宝贝",py:"baobei",idx:2},{zh:"地洞",py:"didong",idx:3},{zh:"龙卷风",py:"longjuanfeng",idx:4}],d=function(){var i=0;return function(t){var e=null;if(i<r.length){var n=r[i];e=$.extend({thumb:"/img_s/"+["ty","0"+n.idx,n.py,"s"].join("_")+".jpg",first:"/ty/"+["ty","0"+n.idx,n.py,1].join("_")+".jpg",second:"/ty/"+["ty","0"+n.idx,n.py,t].join("_")+".jpg"},n),i+=1}return e}}(),l=function(){var i={};return function(t){var e=null,n=i[t];if(n||(n=i[t]=0),n<s[t].length){var a=s[t][n];e=$.extend({thumb:"/img_s/"+[t,"0"+(n+1),a.py,"s"].join("_")+".jpg",first:"/role/"+[t,"0"+(n+1),a.py,1].join("_")+".jpg",second:"/role/"+[t,"0"+(n+1),a.py,2].join("_")+".jpg"},a),i[t]+=1}return e}}(),h=function(){return{cover:"/name/fengmian_1.jpg",kaishi:["/gushi/kaishi_1.jpg","/gushi/kaishi_2.jpg"],jiewei:["/name/jiewei_1.jpg","/gushi/jiewei_2.jpg"],end:"/gushi/fengdi_2.jpg"}},p="//www.sy111.com/book/samples/cn",f=function(i){return i=$.extend({sex:"boy",v:"v1"},i),[p,i.v,i.sex].join("/")},g=function(){return p},u=function(i){var t=[];return i=i.toLowerCase(),$.each(s[i],function(e,n){t.push($.extend({thumb:"/img_s/"+[i,"0"+(e+1),n.py,"s"].join("_")+".jpg",first:"/role/"+[i,"0"+(e+1),n.py,1].join("_")+".jpg",second:"/role/"+[i,"0"+(e+1),n.py,2].join("_")+".jpg"},n))}),t},v="BOOK_INSTANCE";return{getRootPath:g,getNextTy:d,getNextRole:l,getBase:f,getFrontEnd:h,getRoleOptionsByChar:u,checkValid:i,getInstance:function(){var i=sessionStorage.getItem(v);return i?JSON.parse(i):null},setInstance:function(i){sessionStorage.setItem(v,JSON.stringify(i))}}}App.BookData=initGlobalData(),function(i){function t(i){return this.init(i),this}var e=App.BookData;$.extend(t.prototype,{defaultCfg:{$cnt:null,data:{nameStr:"",zhNameStr:"",opt:{}},editable:!0},_activeIdx:0,_btnTpl:'<input type="button" class="ui-button change_btn" value="更改" />',_popTpl:function(){return['<div class="picPopBox ui-arrow-box ui-arrow-box-gray border-radius size-xl">','    <div class="contentBox">','        <h3 class="tc">选择另外一个角色</h3>','        <ol class="roleList">',"           {{each roleList}}",'        	<dd class="roleItem {{$value.py == currentId? "disable" : ""}} cf">','        		<img src="{{_rootPath}}{{$value.thumb}}" class="pic fl"/>',"        		<strong>{{$value.zh}}</strong>","                {{if $value.py === currentId}}",'        		<input type="button" class="ui-button ui-button-L fr disable" value="已选" />',"                {{else}}",'                <input data-py="{{$value.py}}" type="button" class="ui-button ui-button-L fr selBtn" value="可选" />',"                {{/if}}","        	</dd>","           {{/each}}","        </ol>","    </div>",'    <div class="ui-arrow ui-arrow-up">',"       <em>◆</em><i>◆</i>","    </div>","</div> "].join("")}(),_baseTpl:function(){return['<div class="bookfxBox">','    <div class="hd">','        <ul class="lettersBox tc cf">','            <li class="letterItem cover"><div class="coverDot"></div></li>',"            {{each list as item}}",'            <li class="letterItem tc" >','                <div class="charBox"><strong>{{item.ch}}</strong></div>','                <div class="picBox"><img src="{{_rootPath}}{{item.thumb}}" class="pic"/></div>',"            </li>","            {{/each}}",'            <li class="letterItem cover back"><div class="coverDot"></div></li>',"        </ul>","    </div>",'    <div class="bd">',this._getBookTpl(),"    </div>","</div>"].join("")},init:function(i){return this.config=$.extend({},this.defaultCfg,i),i.data.nameStrTrim=i.data.nameStr.replace(/\s/g,""),e.checkValid(i.data.nameStrTrim)?(this._initData(),this._initDom(),this._initEvent(),this.start(),void this.paintName()):void(this.config.onError&&this.config.onError())},paintName:function(){var i=this.config.$bookBox,t=this.config.data.nameStrTrim,e=t.length,n="";e>15?n="XL":e>10&&(n="L");var a='<div class="childNameBox tc '+n+'"><p class="pyName">'+t+'</p><p class="zhName">'+this.config.data.zhNameStr+"</p></div>",s='<div class="childNameCoverBox tc '+n+'"><p class="pyName">'+t+'</p><p class="zhName">'+this.config.data.zhNameStr+"的神奇之旅</p></div>";this._isIE()?(i.find(".j_jiewei").eq(0).prepend(a),i.find(".j_bookCover").eq(1).prepend(s)):(i.find(".j_jiewei").eq(0).append(a),i.find(".j_bookCover").eq(1).append(s))},getResult:function(){return this.config.data.list},_isIE:function(){return!!window.ActiveXObject||"ActiveXObject"in window},_getBookTpl:function(){return this._isIE()?['        <div class="flipBook j_bookFx">','            <div class="flipItem j_flipItem j_bookCover">','				<div class="picBox">','              		<img src="{{_picBase}}{{_frontEnd.cover}}" class="pic"/>',"            	</div>","            </div>","            {{each _frontEnd.kaishi }}",'            <div class="flipItem j_flipItem">','				<div class="picBox">','              		<img src="{{_picBase}}{{$value}}" class="pic"/>',"            	</div>","            </div>","            {{/each}}","            {{each list as item}}",'            <div class="flipItem j_flipItem">','				<div class="picBox">','              		<img src="{{_picBase}}{{item.first}}"  class="pic"/>',"            	</div>","            </div>",'            <div class="flipItem j_flipItem">','				<div class="picBox">','              		<img src="{{_picBase}}{{item.second}}"  class="pic"/>',"            	</div>","            </div>","            {{/each}}","            {{each _frontEnd.jiewei }}",'            <div class="flipItem j_flipItem {{$index === 0 ? "j_jiewei" : ""}}">','				<div class="picBox">','              		<img src="{{_picBase}}{{$value}}" class="pic"/>',"            	</div>","            </div>","            {{/each}}",'            <div class="flipItem j_flipItem">','				<div class="picBox">','              		<img src="{{_picBase}}{{_frontEnd.end}}" class="pic"/>',"            	</div>","            </div>","         </div>"].join(""):['        <div class="Heidelberg-Book with-Spreads j_bookFx">','            <div class="Heidelberg-Spread j_bookCover">','              <img src="{{_picBase}}{{_frontEnd.cover}}" />',"            </div>","            {{each _frontEnd.kaishi }}",'            <div class="Heidelberg-Spread">','              <img src="{{_picBase}}{{$value}}" />',"            </div>","            {{/each}}","            {{each list as item}}",'            <div class="Heidelberg-Spread">','              <img src="{{_picBase}}{{item.first}}" />',"            </div>",'            <div class="Heidelberg-Spread">','              <img src="{{_picBase}}{{item.second}}" />',"            </div>","            {{/each}}","            {{each _frontEnd.jiewei }}",'            <div class="Heidelberg-Spread {{$index ===0 ? "j_jiewei": ""}}">','              <img src="{{_picBase}}{{$value}}" />',"            </div>","            {{/each}}",'            <div class="Heidelberg-Spread">','              <img src="{{_picBase}}{{_frontEnd.end}}" />',"            </div>","         </div>"].join("")},_initData:function(){var i=this.config.data;i.list||(i.list=[],$.each(i.nameStrTrim.split(""),function(t,n){var a=e.getNextRole(n)||e.getNextTy(n);if(!a)throw new Error("[bookFx]不支持的名字。");a.ch=n.toUpperCase(),i.list.push(a)})),this.config.data._picBase=e.getBase(this.config.data.opt),this.config.data._rootPath=e.getRootPath(),this.config.data._frontEnd=e.getFrontEnd()},_initDom:function(){this.config.$cnt.html(template.compile(this._baseTpl())(this.config.data)),this.config.$lettersBox=this.config.$cnt.find(".lettersBox"),this.config.$bookBox=this.config.$cnt.find(".j_bookFx"),this.config.$lettersBox.find(".letterItem").eq(0).addClass("active")},_initEvent:function(){var i=this;$(document).on("click.bookFxHide",function(t){var e=i.config.$lettersBox.find(".letterItem").eq(i._activeIdx).find(".picPopBox");!e.size()||$.contains(e[0],t.target)||$(t.target).hasClass("change_btn")||i._rmPicPop(e)}),this.config.$lettersBox.on("click",".letterItem",function(){var t=$(this);i._checkLetter(t),i._checkChangeBtn()}).on("click",".change_btn",function(){$(this).fadeOut(),i._showOptions()}).on("click",".selBtn",function(){var t=$(this),e=$(this).attr("data-py");i._updateRole(e),i._rmPicPop(t.closest(".picPopBox"))})},_rmPicPop:function(i){i.siblings(".change_btn").fadeIn(),i.remove()},_updateRole:function(i){var t=this.config.$lettersBox.find(".letterItem").eq(this._activeIdx),e=this.config.data.list[this._activeIdx-1],n=this._getOptions(e.ch);$.each(n,function(t,n){n.py===i&&$.extend(e,n)}),t.find(".pic").attr("src",this.config.data._rootPath+e.thumb);var a=4*(this._activeIdx-1)+6,s=this.config.$bookBox.find(".Heidelberg-Page,.j_flipItem").filter(function(i){return i===a||i===a+1});s.find("img").attr("src",this.config.data._picBase+e.first),s=this.config.$bookBox.find(".Heidelberg-Page,.j_flipItem").filter(function(i){return i===a+2||i===a+3}),s.find("img").attr("src",this.config.data._picBase+e.second)},_getOptions:function(i){return e.getRoleOptionsByChar(i)},_showOptions:function(){var i=this.config.$lettersBox.find(".letterItem").eq(this._activeIdx),t=this.config.data.list[this._activeIdx-1];if(t&&!i.find(".picPopBox").size()){i.append(template.compile(this._popTpl)({roleList:this._getOptions(t.ch),currentId:t.py,_rootPath:e.getRootPath()}));var n=i.find(".picPopBox"),a=n.offset().left,s=Math.max($("body").width(),$(".container").width());if(40>a){a=40-a;var o=parseInt(n.css("marginLeft"),10);n.css("marginLeft",o+a),n=i.find(".picPopBox").find(".ui-arrow"),o=parseInt(n.css("marginLeft"),10),n.css("marginLeft",o-a)}else if(a+n.outerWidth()>s){a=a+n.outerWidth()-s+40;var o=parseInt(n.css("marginLeft"),10);n.css("marginLeft",o-a),n=i.find(".picPopBox").find(".ui-arrow"),o=parseInt(n.css("marginLeft"),10),n.css("marginLeft",o+a)}}i.find(".picPopBox").show()},_checkChangeBtn:function(){if(this.config.editable!==!1){var i=this.config.$lettersBox.find(".letterItem").eq(this._activeIdx),t=this.config.data.list[this._activeIdx-1];if(i.siblings().find(".change_btn").fadeOut(),t){var e=new RegExp(t.ch+"([^"+t.ch+"])*"+t.ch,"i");e.test(this.config.data.nameStrTrim)||(i.find(".change_btn").size()||i.append(this._btnTpl),i.find(".change_btn").show())}}},_checkLetter:function(i){if(!i.hasClass("active")){i.addClass("active").siblings(".letterItem").removeClass("active").find(".change_btn,.picPopBox").hide();var t=i.index();this._activeIdx=t,t=this._isIE()?t>0?2*t+2:2:4*(t+1)-1,this.instance.turnPage(t)}},start:function(){var i=this;this.instance=this._isIE()?new App.FlipBook({$el:this.config.$bookBox,onPageTurn:function(t){var e=Math.max(t-3,0);e=Math.ceil(e/2),console.log(t,e),e!=i._activeIdx&&(i._activeIdx=e,i.config.$lettersBox.find(".letterItem").removeClass("active").eq(e).addClass("active"),i.config.$lettersBox.find(".picPopBox").hide(),i._checkChangeBtn())}}):new Heidelberg(this.config.$bookBox,{hasSpreads:!0,onPageTurn:function(t,e){var n=e.pagesTarget.index(),a=null;a=n%4===1?Math.floor(n/4)-1:Math.floor(n/4),a=Math.max(a,0),a=Math.min(a,i.config.$lettersBox.find(".letterItem").length-1),a!=i._activeIdx&&(i._activeIdx=a,i.config.$lettersBox.find(".letterItem").removeClass("active").eq(a).addClass("active"),i.config.$lettersBox.find(".picPopBox").hide(),i._checkChangeBtn())}})},destroy:function(){$(document).off("click.bookFxHide"),this.instance.destroy&&this.instance.destroy()}}),i.BookFx=t}(window.App);
$(function(){function e(e,n){g||(g=new App.PageBar({el:$("#j_pageBox"),cls:"ui_pageBar_L",totalNum:e.count,jumpTo:!1,onPage:function(e){n.pageNo=e,i(n)}}))}function n(){g&&(g.destroy(),g=null)}function t(){i(u)}function i(n){App.ajax({data:n}).done(function(t){t&&t.list&&t.list.length?(l.find(".j_tbdBox").html(template("orderTpl",t)),e(t,n)):l.find(".j_tbdBox").html('<tr><td colspan="8"><p class="tc">暂无订单~</p></td></tr>')}).fail(function(e){App.tip(e&&e.message,"error")}),u=n;try{history.replaceState({},document.title,"?"+$.param(n))}catch(t){}}function r(){var e=l.find(".queryForm");for(var n in f)e.find('[name="'+n+'"]').val(f[n])}function a(){var e="";$.each(c,function(n,t){e+='<option value="'+n+'">'+t+"</option>"}),l.find(".j_orderStatusSel").append(e)}function o(){var e=l.find(".j_beginTime"),n=l.find(".j_endTime"),t=new Date,i=new Date;t.setDate(t.getDate()-7);new App.DatePicker({el:e,val:e.val()?null:t,hasTime:!0,format:"yyyy-MM-dd hh:mm:ss",beforeEl:n}),new App.DatePicker({el:n,val:n.val()?null:i,hasTime:!0,format:"yyyy-MM-dd hh:mm:ss",afterEl:e})}function d(e){var n={};for(var t in e)""!==e[t]&&(n[t]=e[t]);return n}function p(e,n){var i=n.logisticsId;new App.LightBox({type:"confirm",title:"填写物流信息",msg:template("logisticsTpl",n),msgType:"none",timeout:null,confirmFn:function(n){var r=new App.FormValidator({$form:n.domEl.find(".logisticsForm")}),a=r.validate();if(!a.FAILED){var o=$.extend({call:i?"admin.modifyLogistics":"admin.addLogistics",orderId:e},a);i&&(o.logisticsId=i),App.onceAjax({data:o}).done(function(e){e&&(1==e||e.logisticsId)?(App.tip("物流信息填写成功！"),t()):App.tip("物流信息填写失败！","error")}).fail(function(e){App.tip(e&&e.message||"物流信息填写失败！","error")})}}}).show()}var c={0:"未支付",1:"已支付",2:"制作中",3:"已发货",4:"交易成功","-1":"退货退款","-2":"订单作废","-3":"订单取消"},l=$(".adminOrderCnt"),s=new App.FormValidator({$form:l.find(".queryForm")}),f=App.params(),m={call:"admin.listOrder",pageNo:1,pageSize:10},u=null,g=null;l.on("click",".j_queryBtn",function(){var e=s.validate();e.beginTime&&(e.beginTime=new Date(e.beginTime).getTime()),e.endTime&&(e.endTime=new Date(e.endTime).getTime()),i($.extend({},m,d(e))),n()}).on("click",".j_cancelOrder",function(){var e=$(this).closest("tr"),n=e.data("orderid"),i=e.data("orderno");App.confirm("确定取消订单号为["+i+"]的订单吗？",function(){App.onceAjax({data:{call:"admin.cancelOrder",orderId:n}}).done(function(e){1==e?(App.tip("订单取消成功！"),t()):App.tip("订单取消失败！","error")}).fail(function(e){App.tip(e&&e.message||"订单取消失败！","error")})})}).on("click",".j_sendGoods",function(){var e=$(this).closest("tr"),n=e.data("orderid");App.onceAjax({data:{call:"admin.getLogistics",orderId:n}}).done(function(e){p(n,e)}).fail(function(e){App.tip(e&&e.message,"error")})}).on("click",".j_acceptOrder",function(){var e=$(this).closest("tr"),n=e.data("orderid");App.onceAjax({data:{call:"admin.workingOrder",orderId:n}}).done(function(e){1==e?(App.tip("订单确认成功！"),t()):App.tip("订单确认失败！","error")}).fail(function(e){App.tip(e&&e.message,"error")})}).on("click",".j_refundOrder",function(){var e=$(this).closest("tr"),n=e.data("orderid");App.onceAjax({data:{call:"admin.refundOrder",orderId:n}}).done(function(e){1==e?(App.tip("订单退货退款成功！"),t()):App.tip("订单退货退款失败！","error")}).fail(function(e){App.tip(e&&e.message,"error")})}),a(),r(),o(),f.call&&l.find(".j_queryBtn").click()});
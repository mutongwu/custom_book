$(function(){function t(t){return(t/100).toFixed(2)}function i(t){$.each(t,function(t,i){v+=i.statementPrice,I+=i.originalPrice-i.statementPrice,A+=i.statementPrice})}function n(){m.find(".j_total").text(t(v)),m.find(".j_discount").text(t(I)),m.find(".j_price").text(t(A))}function e(){switch(x.length){case 1:return"10%";case 2:return"15%";case 3:return"20%";default:return"20%"}}function o(t){t=t||{};for(var i in t){var n=f.find('[name="'+i+'"]');t[i]&&n.length&&n.val(t[i])}$("#j_distpicker").distpicker({province:t.province,city:t.city,district:t.county})}function r(){App.ajax({data:{call:"address.getDefaultAddressByUserId"}}).always(function(t){o(t)})}function a(){App.ajax({data:{call:"shopCart.list"}}).done(function(t){t&&t.length?(x=t,l.find("#j_cartList").html(template("itemTpl",t)),l.find(".j_discount").text(e()),l.find(".adviceBox,.addressBox,.priceBox,.btnBox").removeClass("none"),r(),i(t),n()):l.find("#j_cartList").html('<p class="tc">购物车空空如也~</p>')}).fail(function(t){App.tip(t&&t.message,"error")})}function d(i,n){App.onceAjax({method:"POST",data:{couponNo:n,call:"shopCart.calcShopCartPrice"}}).done(function(n){n&&n.couponNo?(App.tip("优惠码使用成功,总价已更新"),m.find(".j_discount").text(t(n.originalPrice-n.statementPrice)),m.find(".j_price").text(t(n.statementPrice))):(App.tip("无效的优惠码","error"),i.addClass("ui-input-error"))}).fail(function(t){i.addClass("ui-input-error"),App.tip(t&&t.message,"error")})}function c(){var t=[];return $.each(x,function(i,n){t.push(n.orderGoodsId)}),t.join(",")}function s(){var t=h.validate(),i={call:"order.submitOrder"};if(!t.FAILED){if(!t.addressId)return void App.tip("请先添加收货地址信息.","error");i.addressId=t.addressId,i.orderGoodsIds=c(),i.couponNo=$.trim($(".j_couponInput").val()),App.onceAjax({method:"POST",data:i}).done(function(t){App.tip("订单提交成功，正在前往支付"),setTimeout(function(){App.linkTo("/alipay/pay.do",{orderId:t.orderId})},1e3)}).fail(function(t){App.tip(t&&t.message,"error")})}}function p(t){var i=x[t];App.onceAjax({method:"POST",data:{call:"shopCart.remove",orderGoodsId:i.orderGoodsId}}).done(function(){App.tip("删除成功！"),setTimeout(function(){location.reload(!0)},500)}).fail(function(t){App.tip(t&&t.message,"error")})}var u=require("modules/photoUpload/index"),l=$(".cartCnt"),f=l.find(".j_addressForm"),m=l.find(".j_priceTotal"),h=new App.FormValidator({$form:f}),x=null,v=0,I=0,A=0;l.on("click","#j_submit",function(){s()}).on("click",".j_delItem",function(){var t=$(this).data("idx");App.confirm("确定从购物车删除该绘本吗？",function(){p(t)})}).on("click",".j_cartItemEdit",function(){var t=$(this).data("idx");j.isEditing(t)?App.tip("请先保存其它编辑未完成的绘本信息。","error"):j.init()}).on("click",".j_saveAddress",function(){var t=h.validate();t.FAILED?App.tip("请填写收货地址","error"):(t.call=t.addressId?"address.modifyAddress":"address.saveAddress",App.onceAjax({method:"POST",data:t}).done(function(t){f.find('[name="addressId"]').val(t.addressId),App.tip("收货地址保存成功")}).fail(function(){App.tip("收货地址保存失败","error")}))}).on("click",".j_showCouponTip",function(){new App.LightBox({type:"alert",title:"优惠码说明",msg:template("couponTipTpl",{}),msgType:"none",timeout:null}).show()}).on("blur",".j_couponInput",function(){var t=$.trim(this.value);t&&d($(this),t)}).on("focus",".j_couponInput",function(){$(this).removeClass("ui-input-error")}),a();var j={currIdx:null,currUpload:null,currBookFx:null,isEditing:function(t){return null!==this.currIdx&&this.currIdx!=t?!0:(this.currIdx=t,!1)},init:function(){var t=$(".j_cartItem").eq(this.currIdx).find(".j_editItemCnt");this.$box=t;var i=x[this.currIdx];t.html(template("editItemTpl")).show(),this.currUpload=new u({$container:t.find(".j_photoUploadDiv"),attachmentId:i.attachmentId}),this.currBookFx=new App.BookFx({$cnt:$("#j_bookCnt"),data:{nameStr:i.pinyinName,opt:{sex:1==i.gender?"boy":"girl",v:i.storyId},list:JSON.parse(i.nameInfo)}}),this.$box.find(".ui-textarea").val(i.message),this.$box.find(".j_isPacking").filter('[value="'+i.isPacking+'"]').click(),this.initEvent()},saveItem:function(){var t=this,i=x[this.currIdx];i.attachmentId=this.currUpload.getResult(),i.isPacking=this.$box.find('[name="gift"]:checked').val();var n=this.$box.find(".ui-textarea").val();return n?(i.message=n,i.nameInfo=JSON.stringify(this.currBookFx.getResult()),i.call="shopCart.modify",void App.onceAjax({data:i,method:"POST"}).done(function(i){App.tip(i&&i.message||"商品修改成功！"),t.destroy(),setTimeout(function(){location.reload()},200)}).fail(function(t){App.tip(t&&t.message,"error")})):App.tip("请先填写寄语.","error")},initEvent:function(){var t=this;this.$box.on("click","#j_cancelUpdate",function(){t.destroy()}).on("click","#j_updateCartItem",function(){t.saveItem()})},destroy:function(){this.currBookFx.destroy(),this.currUpload.destroy(),this.currUpload=this.currBookFx=this.currIdx=null,this.$box.off().empty().hide()}}});
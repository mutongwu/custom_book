$(function(){function t(t){switch(+t){case 1:return"个人代理";case 2:return"网店代理";case 3:return"实体店代理"}}function e(e){d.addClass("none"),d.filter('[level="'+e+'"]').removeClass("none"),l.find(".j_typeName").text(t(e)),currentValidator=u[e+""]}function a(){var t=currentValidator.validate(),e=null;if(!t.FAILED&&(e=v.validate(),!e.FAILED)){var a=$.extend({level:l.find(".j_typeRadio:checked").val(),call:"agent.applyAgent"},t,e);return a.pic1&&a.pic2&&a.pic3&&(a.attachmentIds=[a.pic1,a.pic2,a.pic3].join(","),delete a.pic1,delete a.pic2,delete a.pic3),"1"==a.level||a.attachmentIds?void App.onceAjax({data:a,method:"POST"}).done(function(){App.tip("申请成功，请等待审核")}).fail(function(t){App.tip(t&&t.message,"error")}):App.tip("请先上传3张店铺(网店)图片资料","error")}}function n(){return App.ajax({data:{call:"agent.getCouponVo"}})}function i(){return App.ajax({data:{call:"agent.getApplyAgentInfo"}})}function o(){var t=l.find(".uploadInput");t.fileupload({url:"/book/u/f.do",formData:{call:"attachment.upload"},dataType:"json",progress:function(t){$(t.target).siblings(".uploading").show()},done:function(t,e){var a=$(t.target),n=e.result;n.data&&"string"==typeof n.data?(a.siblings(".pic").attr("src","/book/u/s.do?attachmentId="+n.data),a.siblings(".attachmentId").val(n.data)):App.tip(n.message||"图片上传失败.","error"),a.siblings(".uploading").hide()}})}function c(t){var e=t.partnerInfoVo,a=Number(e.level);l.find('.j_typeRadio[value="'+a+'"]').click();for(var n in e)p.find('[name="'+n+'"]').val(e[n]);p.find(".j_distSelect").distpicker({province:e.contactProvince,city:e.contactCity,district:e.contactCounty});var i=d.eq(a-1);for(var n in e)i.find('[name="'+n+'"]').val(e[n]);i.find(".j_distSelect").distpicker({province:e.province,city:e.city,district:e.county}),d.not(a-1).find(".j_distSelect").distpicker(),a>1&&$.each(t.picInfoVoList,function(t,e){i.find(".attachmentId").filter('[name="pic'+(t+1)+'"]').val(e.attachmentId).siblings(".pic").attr("src","/book/u/s.do?attachmentId="+e.attachmentId)}),0==e.status&&l.find(".j_status").text("等待审核中").closest(".ui-form-item").removeClass("none")}function r(){$.when(n(),i()).done(function(t,e){t&&t.level&&l.find(".j_typeRadio").filter(function(){return this.value<=parseInt(t.level)}).attr("disabled","disabled"),e?c(e):(l.find('.j_typeRadio[value="'+f+'"]').click(),$(".j_distSelect").distpicker())}).fail(function(t){App.tip(t&&t.message,"error")})}var l=$(".applyCnt"),d=l.find(".j_applyLevelBox"),p=l.find(".j_contactBox"),s=App.params(),f=1,u={1:new App.FormValidator({$form:d.eq(0)}),2:new App.FormValidator({$form:d.eq(1)}),3:new App.FormValidator({$form:d.eq(2)})},v=new App.FormValidator({$form:p});l.on("change",".j_typeRadio",function(){var t=$(this).val();this.checked&&(f=t,e(t))}).on("click","#j_submit",function(){$(this).hasClass("disable")||a()}),/^([123])$/.test(s.level)&&(f=RegExp.$1),r(),o()});
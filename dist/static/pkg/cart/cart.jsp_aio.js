define("modules/photoUpload/index",function(t,n,i){function o(t){this.config=$.extend({$container:null,attachmentId:null},t),this._id=(new Date).getTime(),this.init()}o.prototype={init:function(){this.style(),this.dom(),this.event(),this.config.attachmentId&&this.config.$container.find(".j_photo").attr("src","/book/u/s.do?attachmentId="+this.config.attachmentId)},getResult:function(){return this.config.$container.find(".attachmentId").val()||this.config.attachmentId},event:function(){var t=this.config.$container;this.$fileupload=t.find(".j_fileupload").fileupload({url:"/book/u/f.do",formData:{call:"attachment.upload"},dataType:"json",done:function(n,i){var o=i.result;o.data&&"string"==typeof o.data?(t.find(".j_photo").attr("src","/book/u/s.do?attachmentId="+o.data),t.find(".attachmentId").val(o.data)):App.tip(o.message||"图片上传失败.","error"),t.find(".progress-bar").hide()},progress:function(){t.find(".progress-bar").show().html("正在上传中，请稍候...")}})},dom:function(){var t='<h3>上传一张孩子或家庭的照片</h3>\r\n<p>照片精度要高，此照片将印到绘本的扉页上</p>\r\n<div class="module-photoBox j_photoBox">\r\n	<div class="photoPreview">\r\n		<img src="//www.sy111.com/book/static/images/user-L.jpg" class="photo j_photo" />\r\n        <span class="progress-bar"></span>\r\n	</div>\r\n	<div class="fieldItem">\r\n		<div class="fileBox clearfix">\r\n			<span class="fl fakeInput"></span>\r\n			<a class="ui-button ui-button-green ui-button-L" >上传照片</a>\r\n			<input type="file" name="bytes" class="uploadfile j_fileupload" />\r\n            <input type="hidden" name="attachmentId" class="attachmentId" />\r\n		</div>\r\n	</div>\r\n</div>';this.domId=this._id+"_dom",this.config.$container.append('<div id="'+this.domId+'">'+t+"</div>")},style:function(){var t=".module-photoBox .photo {\n  width: 100px;\n  height: 100px;\n  border: 1px solid #a5a5a5;\n}\n\n.module-photoBox .fileBox {\n  position: relative;\n  margin: 10px 0;\n}\n\n.module-photoBox .fakeInput {\n  display: inline-block;\n  width: 270px;\n  height: 40px;\n  border: 1px solid #a5a5a5;\n  border-radius: 5px;\n  margin-right: 10px;\n}\n\n.module-photoBox .uploadfile {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  z-index: 1;\n  opacity: 0;\n}\n";this.styleId=this._id+"_style",this.config.$container.append('<style id="'+this.styleId+'">'+t+"</style>")},destroy:function(){this.$fileupload.fileupload("destroy"),this.config.$container.empty()}},i.exports=o});
define("modules/contactForm/index",function(t,i,n){function o(t){this.config=$.extend(!0,{$container:null,data:{formCls:"ui-form-L",submitCls:"ui-button-yellow"}},t),this._id=(new Date).getTime(),this.init()}o.prototype={userInfo:null,init:function(){this.style(),this.dom(),this.event(),this.$formBox=this.config.$container.find(".contactForm"),this.validator=new App.FormValidator({$form:this.$formBox}),this.initData()},initData:function(){var t=this;App.ajax({data:{call:"user.getUserInfo"}}).done(function(i){i&&i.userId&&(t.userInfo=i,t.fillForm(i))})},fillForm:function(t){for(var i in t){var n=this.$formBox.find('[name="'+i+'"]');t[i]&&n.length&&n.val(t[i])}},event:function(){var t=this,i=this.config.$container;i.on("click",".j_submitBtn",function(){t.save()})},check:function(){return this.userInfo.contactEMail||this.userInfo.contactMobile?!0:(App.tip("请先保存联系方式.","error"),!1)},validate:function(){var t=this.validator.validate();return t.FAILED?(App.tip(t.msg,"error"),null):t.contactMobile||t.contactEMail?t:(App.tip("联系电话和电子邮箱不能同时为空","error"),null)},save:function(){var t=this.validate();t&&(delete this.userInfo.updateTime,App.onceAjax({data:$.extend({call:"user.modifyUserInfo"},this.userInfo,t),method:"POST"}).done(function(t){_this.userInfo=t,App.tip("联系方式保存成功！")}).fail(function(t){App.tip(t&&t.message||"联系方式保存失败","error")}))},dom:function(){var t='<div class="ui-form contactForm {{formCls}}">\r\n    <div class="ui-form-item">\r\n        <label class="ui-form-label">联系电话：</label>\r\n        <div class="ui-form-group">\r\n            <input type="text" vtype="phone|tel" maxlength="16"  class="ui-input" name="contactMobile" placeholder="联系电话"/>\r\n            <p class="ui-field-error"></p>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class="ui-form-item">\r\n        <label class="ui-form-label">电子邮箱：</label>\r\n        <div class="ui-form-group">\r\n            <input type="text"  vtype="email"   maxlength="32" class="ui-input" name="contactEMail" placeholder="电子邮箱"/>\r\n            <p class="ui-field-error"></p>\r\n        </div>\r\n    </div>\r\n    <div class="ui-form-item">\r\n        <label class="ui-form-label">&nbsp;</label>\r\n        <div class="ui-form-group">\r\n            <input type="button" class="ui-button ui-button-L j_submitBtn {{submitCls}}" value="保存" />\r\n        </div>\r\n    </div>\r\n</div>';this.domId=this._id+"_dom",t='<div id="'+this.domId+'">'+t+"</div>";var i=template.compile(t);this.config.$container.append(i(this.config.data))},style:function(){var t="";this.styleId=this._id+"_style",this.config.$container.append('<style id="'+this.styleId+'">'+t+"</style>")},destroy:function(){this.validator&&this.validator.destroy(),this.config.$container.empty(),this.config=null}},n.exports=o});
$(function(){function t(t){return(t/100).toFixed(2)}function i(t){$.each(t,function(t,i){I+=i.statementPrice,j+=i.originalPrice-i.statementPrice,g+=i.statementPrice})}function e(){h.find(".j_total").text(t(I)),h.find(".j_discount").text(t(j)),h.find(".j_price").text(t(g))}function n(){switch(v.length){case 1:return"10%";case 2:return"15%";case 3:return"20%";default:return"20%"}}function o(t){t=t||{};for(var i in t){var e=m.find('[name="'+i+'"]');t[i]&&e.length&&e.val(t[i])}$("#j_distpicker").distpicker({province:t.province,city:t.city,district:t.county})}function r(){App.ajax({data:{call:"address.getDefaultAddressByUserId"}}).always(function(t){o(t)})}function a(){App.ajax({data:{call:"shopCart.list"}}).done(function(t){t&&t.length?(v=t,f.find("#j_cartList").html(template("itemTpl",t)),f.find(".j_discount").text(n()),f.find(".adviceBox,.addressBox,.priceBox,.btnBox").removeClass("none"),r(),i(t),e()):f.find("#j_cartList").html('<p class="tc">购物车空空如也~</p>')}).fail(function(t){App.tip(t&&t.message,"error")})}function c(i,e){App.onceAjax({method:"POST",data:{couponNo:e,call:"shopCart.calcShopCartPrice"}}).done(function(e){e&&e.couponNo?(App.tip("优惠码使用成功,总价已更新"),h.find(".j_discount").text(t(e.originalPrice-e.statementPrice)),h.find(".j_price").text(t(e.statementPrice))):(App.tip("无效的优惠码","error"),i.addClass("ui-input-error"))}).fail(function(t){i.addClass("ui-input-error"),App.tip(t&&t.message,"error")})}function d(){var t=[];return $.each(v,function(i,e){t.push(e.orderGoodsId)}),t.join(",")}function s(){var t=x.validate(),i={call:"order.submitOrder"};if(t.FAILED)App.tip("请先添加收货地址信息.","error");else{if(!t.addressId)return void App.tip("请先添加收货地址信息.","error");if(!A.check())return;i.addressId=t.addressId,i.orderGoodsIds=d(),i.couponNo=$.trim($(".j_couponInput").val()),App.onceAjax({method:"POST",data:i}).done(function(t){App.tip("订单提交成功，正在前往支付"),setTimeout(function(){App.linkTo("/alipay/pay.do",{orderId:t.orderId})},1e3)}).fail(function(t){App.tip(t&&t.message,"error")})}}function p(t){var i=v[t];App.onceAjax({method:"POST",data:{call:"shopCart.remove",orderGoodsId:i.orderGoodsId}}).done(function(){App.tip("删除成功！"),setTimeout(function(){location.reload(!0)},500)}).fail(function(t){App.tip(t&&t.message,"error")})}var u=require("modules/photoUpload/index"),l=require("modules/contactForm/index"),f=$(".cartCnt"),m=f.find(".j_addressForm"),h=f.find(".j_priceTotal"),x=new App.FormValidator({$form:m}),v=null,A=new l({$container:f.find("#j_contactFormBox"),data:{formCls:"ui-form-L",submitCls:"ui-button-XL ui-button-green"}}),I=0,j=0,g=0;f.on("click","#j_submit",function(){s()}).on("click",".j_delItem",function(){var t=$(this).data("idx");App.confirm("确定从购物车删除该绘本吗？",function(){p(t)})}).on("click",".j_cartItemEdit",function(){var t=$(this).data("idx");_.isEditing(t)?App.tip("请先保存其它编辑未完成的绘本信息。","error"):_.init()}).on("click",".j_saveAddress",function(){var t=x.validate();t.FAILED?App.tip("请填写收货地址","error"):(t.call=t.addressId?"address.modifyAddress":"address.saveAddress",App.onceAjax({method:"POST",data:t}).done(function(t){m.find('[name="addressId"]').val(t.addressId),App.tip("收货地址保存成功")}).fail(function(){App.tip("收货地址保存失败","error")}))}).on("click",".j_showCouponTip",function(){new App.LightBox({type:"alert",title:"优惠码说明",msg:template("couponTipTpl",{}),msgType:"none",timeout:null}).show()}).on("blur",".j_couponInput",function(){var t=$.trim(this.value);t&&c($(this),t)}).on("focus",".j_couponInput",function(){$(this).removeClass("ui-input-error")}),a();var _={currIdx:null,currUpload:null,currBookFx:null,isEditing:function(t){return null!==this.currIdx&&this.currIdx!=t?!0:(this.currIdx=t,!1)},init:function(){var t=$(".j_cartItem").eq(this.currIdx).find(".j_editItemCnt");this.$box=t;var i=v[this.currIdx];t.html(template("editItemTpl")).show(),this.currUpload=new u({$container:t.find(".j_photoUploadDiv"),attachmentId:i.attachmentId}),this.currBookFx=new App.BookFx({$cnt:$("#j_bookCnt"),data:{nameStr:i.pinyinName,zhNameStr:i.chineseName,opt:{sex:1==i.gender?"boy":"girl",v:i.storyId},list:JSON.parse(i.nameInfo)}}),this.$box.find(".ui-textarea").val(i.message),this.$box.find(".j_isPacking").filter('[value="'+i.isPacking+'"]').click(),this.initEvent()},saveItem:function(){var t=this,i=v[this.currIdx];i.attachmentId=this.currUpload.getResult(),i.isPacking=this.$box.find('[name="gift"]:checked').val();var e=this.$box.find(".ui-textarea").val();return e?(i.message=e,i.nameInfo=JSON.stringify(this.currBookFx.getResult()),i.call="shopCart.modify",void App.onceAjax({data:i,method:"POST"}).done(function(i){App.tip(i&&i.message||"商品修改成功！"),t.destroy(),setTimeout(function(){location.reload()},200)}).fail(function(t){App.tip(t&&t.message,"error")})):App.tip("请先填写寄语.","error")},initEvent:function(){var t=this;this.$box.on("click","#j_cancelUpdate",function(){t.destroy()}).on("click","#j_updateCartItem",function(){t.saveItem()})},destroy:function(){this.currBookFx.destroy(),this.currUpload.destroy(),this.currUpload=this.currBookFx=this.currIdx=null,this.$box.off().empty().hide()}}});
